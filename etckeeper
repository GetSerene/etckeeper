#!/bin/sh
set -e

if [ -e /etc/etckeeper/etckeeper.conf ]; then
	. /etc/etckeeper/etckeeper.conf
fi

if [ ! -z "$GIT_COMMIT_OPTIONS" ]; then
	export GIT_COMMIT_OPTIONS
fi

if [ -z "$1" ]; then
	echo "usage: etckeeper command [directory]" >&2
	exit 1
fi
command="$1"
shift 1

if [ ! -d "/etc/etckeeper/$command.d" ]; then
	echo "etckeeper: /etc/etckeeper/$command.d does not exist" >&2
	exit 1
fi

if [ -n "$1" ] && [ "$1" == "::AUTO::" ]; then
	for i in `tail -n +1 /etc/etckeeper/package_managed_dirs`; do
		cd $i && run-parts --exit-on-error "/etc/etckeeper/$command.d"
	done
elif [ -n "$1" ]
	cd "$1" && run-parts --exit-on-error "/etc/etckeeper/$command.d"
else
	cd /etc && run-parts --exit-on-error "/etc/etckeeper/$command.d"
fi


